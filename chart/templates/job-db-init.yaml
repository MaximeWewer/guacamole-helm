{{- $dbEnabled := or .Values.postgresql.enabled .Values.mysql.enabled .Values.mariadb.enabled .Values.database.external.enabled -}}
{{- /* Determine the effective database type based on enabled flags */ -}}
{{- $dbType := "" -}}
{{- if .Values.postgresql.enabled -}}
  {{- $dbType = "postgresql" -}}
{{- else if .Values.mysql.enabled -}}
  {{- $dbType = "mysql" -}}
{{- else if .Values.mariadb.enabled -}}
  {{- $dbType = "mariadb" -}}
{{- else if .Values.database.external.enabled -}}
  {{- $dbType = .Values.database.type -}}
{{- end -}}
{{- if $dbEnabled }}
apiVersion: batch/v1
kind: Job
metadata:
  name: {{ include "guacamole.fullname" . }}-db-init
  labels:
    {{- include "guacamole.labels" . | nindent 4 }}
    app.kubernetes.io/component: db-init
  annotations:
    "helm.sh/hook": post-install,post-upgrade
    "helm.sh/hook-weight": "0"
    "helm.sh/hook-delete-policy": before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  backoffLimit: 10
  template:
    metadata:
      labels:
        {{- include "guacamole.labels" . | nindent 8 }}
        app.kubernetes.io/component: db-init
    spec:
      {{- with .Values.guacamole.imagePullSecrets }}
      imagePullSecrets:
        {{- toYaml . | nindent 8 }}
      {{- end }}
      restartPolicy: OnFailure
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
      initContainers:
        # Wait for database to be ready
        - name: wait-for-db
          image: busybox:1.36
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              echo "Waiting for database at $DB_HOST:$DB_PORT..."
              until nc -z -w5 "$DB_HOST" "$DB_PORT"; do
                echo "Database not ready, waiting..."
                sleep 5
              done
              echo "Database is reachable!"
              # Give the database a bit more time to fully initialize
              sleep 10
          env:
            - name: DB_HOST
              value: {{ include "guacamole.database.hostname" . | quote }}
            - name: DB_PORT
              value: {{ include "guacamole.database.port" . | quote }}
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: true
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              memory: 32Mi
              cpu: 10m
            limits:
              memory: 64Mi
              cpu: 100m
        # Generate the SQL schema
        - name: generate-schema
          image: {{ include "guacamole.image" . }}
          imagePullPolicy: {{ .Values.guacamole.image.pullPolicy }}
          command:
            - /bin/sh
            - -c
            - |
              echo "Generating Guacamole database schema..."
              {{- if eq $dbType "postgresql" }}
              /opt/guacamole/bin/initdb.sh --postgresql > /schema/initdb.sql
              {{- else if or (eq $dbType "mysql") (eq $dbType "mariadb") }}
              /opt/guacamole/bin/initdb.sh --mysql > /schema/initdb.sql
              {{- else if eq $dbType "sqlserver" }}
              /opt/guacamole/bin/initdb.sh --sqlserver > /schema/initdb.sql
              {{- end }}
              echo "Schema generated successfully ($(wc -l < /schema/initdb.sql) lines)"
          volumeMounts:
            - name: schema
              mountPath: /schema
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              memory: 128Mi
              cpu: 100m
            limits:
              memory: 256Mi
              cpu: 200m
      containers:
        # Apply the schema to the database
        - name: apply-schema
          {{- if eq $dbType "postgresql" }}
          # Use the same PostgreSQL image as the CNPG cluster for version compatibility
          image: {{ .Values.postgresql.image.repository }}:{{ .Values.postgresql.image.tag }}
          {{- else if eq $dbType "mysql" }}
          # Use MySQL image matching the operator cluster version
          image: mysql:{{ .Values.mysql.version }}
          {{- else if eq $dbType "mariadb" }}
          # Use the same MariaDB image as the operator for version compatibility
          image: {{ .Values.mariadb.image.repository }}:{{ .Values.mariadb.image.tag }}
          {{- else if eq $dbType "sqlserver" }}
          # SQL Server is external only - use mssql-tools for client
          image: mcr.microsoft.com/mssql-tools:latest
          {{- end }}
          imagePullPolicy: IfNotPresent
          command:
            - /bin/sh
            - -c
            - |
              set -e

              {{- if eq $dbType "postgresql" }}
              # PostgreSQL
              export PGPASSWORD="$DB_PASSWORD"

              echo "Checking if schema already exists..."
              TABLES_EXIST=$(psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -tAc \
                "SELECT EXISTS (SELECT FROM information_schema.tables WHERE table_schema = 'public' AND table_name = 'guacamole_user');" 2>/dev/null || echo "f")

              if [ "$TABLES_EXIST" = "t" ]; then
                echo "Guacamole schema already exists. Skipping initialization."
              else
                echo "Applying Guacamole schema..."
                psql -h "$DB_HOST" -p "$DB_PORT" -U "$DB_USER" -d "$DB_NAME" -f /schema/initdb.sql
                echo "Schema applied successfully!"
              fi

              {{- else if eq $dbType "mysql" }}
              # MySQL (InnoDB Cluster) - use root to initialize
              echo "Creating database and user if not exists..."
              mysql -h "$DB_HOST" -P "$DB_PORT" -u root -p"$ROOT_PASSWORD" -e \
                "CREATE DATABASE IF NOT EXISTS \`$DB_NAME\`;"
              mysql -h "$DB_HOST" -P "$DB_PORT" -u root -p"$ROOT_PASSWORD" -e \
                "CREATE USER IF NOT EXISTS '$DB_USER'@'%' IDENTIFIED BY '$DB_PASSWORD';"
              mysql -h "$DB_HOST" -P "$DB_PORT" -u root -p"$ROOT_PASSWORD" -e \
                "GRANT ALL PRIVILEGES ON \`$DB_NAME\`.* TO '$DB_USER'@'%'; FLUSH PRIVILEGES;"

              echo "Checking if schema already exists..."
              TABLES_EXIST=$(mysql -h "$DB_HOST" -P "$DB_PORT" -u root -p"$ROOT_PASSWORD" "$DB_NAME" -sNe \
                "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = '$DB_NAME' AND table_name = 'guacamole_user';" 2>/dev/null || echo "0")

              if [ "$TABLES_EXIST" -gt 0 ]; then
                echo "Guacamole schema already exists. Skipping initialization."
              else
                echo "Applying Guacamole schema..."
                mysql -h "$DB_HOST" -P "$DB_PORT" -u root -p"$ROOT_PASSWORD" "$DB_NAME" < /schema/initdb.sql
                echo "Schema applied successfully!"
              fi

              {{- else if eq $dbType "mariadb" }}
              # MariaDB - user is created by operator CRDs, just apply schema
              # MariaDB image uses 'mariadb' command instead of 'mysql'
              echo "Checking if schema already exists..."
              TABLES_EXIST=$(mariadb -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" -sNe \
                "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = '$DB_NAME' AND table_name = 'guacamole_user';" 2>/dev/null || echo "0")

              if [ "$TABLES_EXIST" -gt 0 ]; then
                echo "Guacamole schema already exists. Skipping initialization."
              else
                echo "Applying Guacamole schema..."
                mariadb -h "$DB_HOST" -P "$DB_PORT" -u "$DB_USER" -p"$DB_PASSWORD" "$DB_NAME" < /schema/initdb.sql
                echo "Schema applied successfully!"
              fi

              {{- else if eq $dbType "sqlserver" }}
              # SQL Server
              echo "Checking if schema already exists..."
              TABLES_EXIST=$(/opt/mssql-tools18/bin/sqlcmd -S "$DB_HOST,$DB_PORT" -U "$DB_USER" -P "$DB_PASSWORD" -d "$DB_NAME" -C -h -1 -Q \
                "SET NOCOUNT ON; SELECT COUNT(*) FROM INFORMATION_SCHEMA.TABLES WHERE TABLE_NAME = 'guacamole_user'" 2>/dev/null | tr -d ' ' || echo "0")

              if [ "$TABLES_EXIST" -gt 0 ]; then
                echo "Guacamole schema already exists. Skipping initialization."
              else
                echo "Applying Guacamole schema..."
                /opt/mssql-tools18/bin/sqlcmd -S "$DB_HOST,$DB_PORT" -U "$DB_USER" -P "$DB_PASSWORD" -d "$DB_NAME" -C -i /schema/initdb.sql
                echo "Schema applied successfully!"
              fi
              {{- end }}

              echo "Database initialization completed."
          env:
            - name: DB_HOST
              value: {{ include "guacamole.database.hostname" . | quote }}
            - name: DB_PORT
              value: {{ include "guacamole.database.port" . | quote }}
            - name: DB_NAME
              value: {{ include "guacamole.database.name" . | quote }}
            - name: DB_USER
              value: {{ include "guacamole.database.username" . | quote }}
            - name: DB_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "guacamole.database.secretName" . }}
                  key: {{ include "guacamole.database.secretKey" . }}
            {{- if eq $dbType "mysql" }}
            - name: ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: {{ include "guacamole.database.secretName" . }}
                  key: rootPassword
            {{- end }}
          volumeMounts:
            - name: schema
              mountPath: /schema
              readOnly: true
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
          resources:
            requests:
              memory: 128Mi
              cpu: 100m
            limits:
              memory: 256Mi
              cpu: 200m
      volumes:
        - name: schema
          emptyDir: {}
{{- end }}
